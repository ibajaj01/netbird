##############################################################################
# NetBird Production Deployment for AKS with NGINX Ingress
# Domain: netbird.redzapp.net
# Authentication: Microsoft Entra ID
##############################################################################

## @section Global Configuration
global:
  namespace: "netbird"

nameOverride: ""
fullnameOverride: ""

##############################################################################
## @section NetBird Management Service
##############################################################################
management:
  enabled: true
  replicaCount: 1  # Increased for production HA

  ## Management pod command arguments
  podCommand:
    args:
      - --port=80
      - --log-file=console
      - --log-level=info
      - --disable-anonymous-metrics=false
      - --single-account-mode-domain=netbird.redzapp.net
      - --dns-domain=netbird.redzapp.net
      - --config=/var/lib/netbird/management.json

  ## Management ConfigMap - leave as placeholder
  configmap: |
    {
      "Stuns": [
        {
          "Proto": "udp",
          "URI": "stun:stun.l.google.com:19302",
          "Username": "",
          "Password": null
        }
      ],
      "TURNConfig": {
        "Turns": [],
        "CredentialsTTL": "12h0m0s",
        "Secret": "netbird-turn-secret",
        "TimeBasedCredentials": false
      },
      "Signal": {
        "Proto": "https",
        "URI": "netbird.redzapp.net:443",
        "Username": "",
        "Password": null
      },
      "Datadir": "/var/lib/netbird",
      "DataStoreEncryptionKey": "",
      "HttpConfig": {
        "Address": "0.0.0.0:80",
        "AuthIssuer": "https://login.microsoftonline.com/659797b6-8e8d-4b80-bca0-867f365f83b0/v2.0",
        "AuthAudience": "be388de1-4ca4-4c34-b9aa-76848bd01844",
        "AuthKeysLocation": "",
        "OIDCConfigEndpoint": "https://login.microsoftonline.com/659797b6-8e8d-4b80-bca0-867f365f83b0/v2.0/.well-known/openid-configuration",
        "IdpSignKeyRefreshEnabled": true
      },
      "DeviceAuthorizationFlow": {
        "Provider": "azure",
        "ProviderConfig": {
          "Audience": "be388de1-4ca4-4c34-b9aa-76848bd01844",
          "ClientID": "be388de1-4ca4-4c34-b9aa-76848bd01844",
          "ClientSecret": "",
          "TokenEndpoint": "https://login.microsoftonline.com/659797b6-8e8d-4b80-bca0-867f365f83b0/oauth2/v2.0/token",
          "DeviceAuthEndpoint": "https://login.microsoftonline.com/659797b6-8e8d-4b80-bca0-867f365f83b0/oauth2/v2.0/devicecode",
          "AuthorizationEndpoint": "https://login.microsoftonline.com/659797b6-8e8d-4b80-bca0-867f365f83b0/oauth2/v2.0/authorize",
          "Scope": "openid profile email offline_access api://be388de1-4ca4-4c34-b9aa-76848bd01844/api",
          "UseIDToken": false,
          "RedirectURLs": null
        }
      },
      "PKCEAuthorizationFlow": {
        "ProviderConfig": {
          "Audience": "be388de1-4ca4-4c34-b9aa-76848bd01844",
          "ClientID": "be388de1-4ca4-4c34-b9aa-76848bd01844",
          "ClientSecret": "",
          "TokenEndpoint": "https://login.microsoftonline.com/659797b6-8e8d-4b80-bca0-867f365f83b0/oauth2/v2.0/token",
          "AuthorizationEndpoint": "https://login.microsoftonline.com/659797b6-8e8d-4b80-bca0-867f365f83b0/oauth2/v2.0/authorize",
          "Scope": "openid profile email offline_access api://be388de1-4ca4-4c34-b9aa-76848bd01844/api",
          "RedirectURLs": ["https://netbird.redzapp.net"],
          "UseIDToken": false
        }
      }
    }

  lifecycle: {}

  ## Environment variables for Microsoft Entra ID authentication
  env: {}

  envRaw:
    # Microsoft Entra ID Configuration
    - name: NETBIRD_IDP
      value: "azure"
    
    - name: NETBIRD_TENANT_ID
      valueFrom:
        secretKeyRef:
          name: netbird-entra-secret
          key: tenant-id
    
    - name: NETBIRD_AUTH_CLIENT_ID
      valueFrom:
        secretKeyRef:
          name: netbird-entra-secret
          key: client-id
    
    - name: NETBIRD_AUTH_CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          name: netbird-entra-secret
          key: client-secret
    
    - name: NETBIRD_AUTH_AUDIENCE
      valueFrom:
        secretKeyRef:
          name: netbird-entra-secret
          key: client-id
    
    - name: NETBIRD_AUTH_AUTHORITY
      value: "https://login.microsoftonline.com/$(NETBIRD_TENANT_ID)"
    
    - name: NETBIRD_AUTH_SUPPORTED_SCOPES
      value: "openid profile email offline_access api://$(NETBIRD_AUTH_CLIENT_ID)/api"
    
    - name: NETBIRD_AUTH_REDIRECT_URL
      value: "https://netbird.redzapp.net"
    
    - name: NETBIRD_AUTH_SILENT_REDIRECT_URL
      value: "https://netbird.redzapp.net/silent-auth"
    
    - name: NETBIRD_AUTH_DEVICE_AUTH_ENDPOINT
      value: "https://login.microsoftonline.com/$(NETBIRD_TENANT_ID)/oauth2/v2.0/devicecode"
    
    - name: NETBIRD_AUTH_TOKEN_ENDPOINT
      value: "https://login.microsoftonline.com/$(NETBIRD_TENANT_ID)/oauth2/v2.0/token"
    
    - name: NETBIRD_AUTH_AUTHORIZATION_ENDPOINT
      value: "https://login.microsoftonline.com/$(NETBIRD_TENANT_ID)/oauth2/v2.0/authorize"
    
    - name: NETBIRD_AUTH_JWKS_ENDPOINT
      value: "https://login.microsoftonline.com/$(NETBIRD_TENANT_ID)/discovery/v2.0/keys"
    
    - name: NETBIRD_AUTH_ISSUER
      value: "https://login.microsoftonline.com/$(NETBIRD_TENANT_ID)/v2.0"
    
    - name: NETBIRD_AUTH_USER_ID_CLAIM
      value: "oid"
    
    # Storage Configuration
    - name: NETBIRD_STORE_ENGINE
      value: "sqlite"
    
    - name: NETBIRD_DATADIR
      value: "/var/lib/netbird"

  envFromSecret: {}

  ## Docker image configuration
  image:
    repository: netbirdio/management
    pullPolicy: IfNotPresent
    tag: ""

  imagePullSecrets: []

  ## Service Account
  serviceAccount:
    create: true
    annotations: {}
    name: ""

  ## Deployment and Pod annotations
  deploymentAnnotations: {}
  
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"

  ## Security contexts
  podSecurityContext: {}

  securityContext: {}

  ## Use backwards compatible GRPC service
  useBackwardsGrpcService: false

  ## Metrics configuration
  metrics:
    enabled: true
    port: 9090

  ## Container port
  containerPort: 80

  ## HTTP Service configuration
  service:
    type: ClusterIP
    port: 80
    name: http
    externalIPs: []
    annotations: {}

  ## gRPC Container port
  grpcContainerPort: 33073

  ## gRPC Service configuration
  serviceGrpc:
    type: ClusterIP  # Changed from LoadBalancer - NGINX supports gRPC natively
    port: 33073
    name: grpc
    externalIPs: []
    annotations: {}

  ## HTTP Ingress - DISABLED (using consolidated ingress below)
  ingress:
    enabled: false

  ## gRPC Ingress - DISABLED (using consolidated ingress below)
  ingressGrpc:
    enabled: false

  ## Resource limits and requests
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi

  ## Persistent Volume for data storage
  persistentVolume:
    enabled: true
    accessModes:
      - ReadWriteOnce
    size: 10Gi
    storageClass: "default2"
    existingPVName: ""

  ## Health probes
  livenessProbe:
    failureThreshold: 3
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    tcpSocket:
      port: http

  readinessProbe:
    failureThreshold: 3
    initialDelaySeconds: 15
    periodSeconds: 10
    timeoutSeconds: 5
    tcpSocket:
      port: http

  ## Volume mounts and volumes
  volumeMounts: []
  volumes: []

##############################################################################
## @section NetBird Signal Service
##############################################################################
signal:
  enabled: true
  replicaCount: 1
  logLevel: info

  ## Docker image
  image:
    repository: netbirdio/signal
    pullPolicy: IfNotPresent
    tag: ""

  imagePullSecrets: []

  ## Service Account
  serviceAccount:
    create: true
    annotations: {}
    name: ""

  ## Annotations
  deploymentAnnotations: {}
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"

  ## Security contexts
  podSecurityContext: {}

  securityContext: {}

  ## Metrics
  metrics:
    enabled: true
    port: 9090

  ## Container port
  containerPort: 80

  ## Service configuration - Changed to ClusterIP for NGINX
  service:
    type: ClusterIP
    port: 80
    name: grpc
    externalIPs: []
    annotations: {}

  ## Ingress - DISABLED (using consolidated ingress)
  ingress:
    enabled: false

  ## Resources
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

  ## Health probes
  livenessProbe:
    initialDelaySeconds: 10
    periodSeconds: 10
    tcpSocket:
      port: grpc

  readinessProbe:
    initialDelaySeconds: 5
    periodSeconds: 10
    tcpSocket:
      port: grpc

  volumeMounts: []
  volumes: []

##############################################################################
## @section NetBird Relay Service
##############################################################################
relay:
  enabled: true
  replicaCount: 1
  logLevel: info

  env: {}
  envRaw:
    # REQUIRED: Relay exposed address - this is how peers will reach the relay
    - name: NB_EXPOSED_ADDRESS
      value: "rels://netbird.redzapp.net:443"  # or use relay subdomain if you create one
    - name: NB_LISTEN_ADDRESS
      value: ":33080"
    - name: NB_AUTH_SECRET
      value: "9YsCwd83b9aGVqa/nmSrmFwT18sXEk/+cOSoFxotoX8="

  envFromSecret: {}

  ## Docker image
  image:
    repository: netbirdio/relay
    pullPolicy: IfNotPresent
    tag: ""

  imagePullSecrets: []

  ## Service Account
  serviceAccount:
    create: true
    annotations: {}
    name: ""

  ## Annotations
  deploymentAnnotations: {}
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"

  ## Security contexts
  podSecurityContext: {}

  securityContext: {}

  ## Metrics
  metrics:
    enabled: true
    port: 9090

  ## Container port
  containerPort: 33080

  ## Service
  service:
    type: ClusterIP
    port: 33080
    name: http
    externalIPs: []
    annotations: {}

  ## Ingress - DISABLED (using consolidated ingress)
  ingress:
    enabled: false

  ## Resources
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  ## Health probes
  livenessProbe:
    initialDelaySeconds: 10
    periodSeconds: 10
    tcpSocket:
      port: http

  readinessProbe:
    initialDelaySeconds: 5
    periodSeconds: 10
    tcpSocket:
      port: http

  volumeMounts: []
  volumes: []

##############################################################################
## @section NetBird Dashboard
##############################################################################
dashboard:
  enabled: true
  replicaCount: 1

  ## Dashboard command
  podCommand:
    args: []

  ## Docker image
  image:
    repository: netbirdio/dashboard
    pullPolicy: IfNotPresent
    tag: "latest"

  imagePullSecrets: []

  ## Service Account
  serviceAccount:
    create: true
    annotations: {}
    name: ""

  ## Annotations
  podAnnotations: {}

  ## Security contexts
  podSecurityContext: {}

  securityContext: {}

  ## Container port
  containerPort: 80

  ## Service
  service:
    type: ClusterIP
    port: 80
    name: http
    externalIPs: []
    annotations: {}

  ## Ingress - DISABLED (using consolidated ingress)
  ingress:
    enabled: false

  ## Resources
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  ## Environment variables for dashboard
  env: {}

  envRaw:
    - name: NETBIRD_TENANT_ID
      valueFrom:
        secretKeyRef:
          name: netbird-entra-secret
          key: tenant-id
    
    - name: AUTH_CLIENT_ID
      valueFrom:
        secretKeyRef:
          name: netbird-entra-secret
          key: client-id
    
    - name: AUTH_AUDIENCE
      valueFrom:
        secretKeyRef:
          name: netbird-entra-secret
          key: client-id
    
    - name: AUTH_AUTHORITY
      value: "https://login.microsoftonline.com/$(NETBIRD_TENANT_ID)"
    
    - name: USE_AUTH0
      value: "false"
    
    - name: AUTH_SUPPORTED_SCOPES
      value: "openid profile email offline_access api://$(AUTH_CLIENT_ID)/api"
    
    - name: AUTH_REDIRECT_URI
      value: "https://netbird.redzapp.net/auth"
    
    - name: AUTH_SILENT_REDIRECT_URI
      value: "https://netbird.redzapp.net/silent-auth"
    
    - name: NETBIRD_MGMT_API_ENDPOINT
      value: "https://netbird.redzapp.net"
    
    - name: NETBIRD_MGMT_GRPC_API_ENDPOINT
      value: "https://netbird.redzapp.net"
    
    - name: NETBIRD_HOTJAR_TRACK_ID
      value: ""
    
    - name: NETBIRD_GOOGLE_ANALYTICS_ID
      value: ""

  envFromSecret: {}

  lifecycle: {}

  ## Health probes
  livenessProbe:
    periodSeconds: 10
    httpGet:
      path: /
      port: http

  readinessProbe:
    initialDelaySeconds: 5
    periodSeconds: 10
    httpGet:
      path: /
      port: http

  volumeMounts: []
  volumes: []

##############################################################################
## @section Let's Encrypt Issuer
##############################################################################
issuer:
  production:
    create: true
    email: "i.ajaj@homyt.net"

##############################################################################
## @section Extra Manifests - Consolidated Ingress for NGINX
##############################################################################
extraManifests:
  # Main HTTP/HTTPS Ingress
  - apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: netbird-http
      namespace: netbird
      annotations:
        # cert-manager configuration
        cert-manager.io/cluster-issuer: "letsencrypt-prod"
        
        # NGINX specific annotations
        nginx.ingress.kubernetes.io/ssl-redirect: "false"
        nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
        nginx.ingress.kubernetes.io/proxy-body-size: "0"
        nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
        nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    spec:
      ingressClassName: nginx
      tls:
      - hosts:
        - netbird.redzapp.net
        secretName: netbird-http-tls
      rules:
      - host: netbird.redzapp.net
        http:
          paths:
          # Management API endpoints (highest priority)
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: netbird-management
                port:
                  number: 80
          
          # Relay service
          - path: /relay
            pathType: Prefix
            backend:
              service:
                name: netbird-relay
                port:
                  number: 33080
          
          # Authentication callback paths
          - path: /auth
            pathType: Prefix
            backend:
              service:
                name: netbird-dashboard
                port:
                  number: 80
          
          - path: /silent-auth
            pathType: Prefix
            backend:
              service:
                name: netbird-dashboard
                port:
                  number: 80
          
          # Dashboard static assets
          - path: /static
            pathType: Prefix
            backend:
              service:
                name: netbird-dashboard
                port:
                  number: 80
          
          - path: /assets
            pathType: Prefix
            backend:
              service:
                name: netbird-dashboard
                port:
                  number: 80
          
          # Dashboard root (catch-all - MUST be last)
          - path: /
            pathType: Prefix
            backend:
              service:
                name: netbird-dashboard
                port:
                  number: 80

  # gRPC Ingress for Management Service
  - apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: netbird-grpc-management
      namespace: netbird
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-prod"
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
        nginx.ingress.kubernetes.io/backend-protocol: "GRPC"
        nginx.ingress.kubernetes.io/grpc-backend: "true"
    spec:
      ingressClassName: nginx
      tls:
      - hosts:
        - netbird.redzapp.net
        secretName: netbird-grpc-management-tls
      rules:
      - host: netbird.redzapp.net
        http:
          paths:
          - path: /management.ManagementService
            pathType: Prefix
            backend:
              service:
                name: netbird-management-grpc
                port:
                  number: 33073

  # gRPC Ingress for Signal Service
  - apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: netbird-grpc-signal
      namespace: netbird
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-prod"
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
        nginx.ingress.kubernetes.io/backend-protocol: "GRPC"
        nginx.ingress.kubernetes.io/grpc-backend: "true"
    spec:
      ingressClassName: nginx
      tls:
      - hosts:
        - netbird.redzapp.net
        secretName: netbird-grpc-signal-tls
      rules:
      - host: netbird.redzapp.net
        http:
          paths:
          - path: /signalexchange.SignalExchange
            pathType: Prefix
            backend:
              service:
                name: netbird-signal
                port:
                  number: 80


##############################################################################
## @section Prometheus Metrics
##############################################################################
metrics:
  serviceMonitor:
    enabled: false
    namespace: "netbird"
    annotations: {}
    labels: {}
    jobLabel: ""
    honorLabels: false
    interval: "30s"
    scrapeTimeout: "10s"
    metricRelabelings: []
    relabelings: []
    selector: {}
